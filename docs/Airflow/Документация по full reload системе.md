# Описание выгрузки full_reload

Для реализации схемы **full_reload** между источником (source) и приёмником была разработана следующая архитектура.

<image src="https://github.com/NikGerasimovich98/Data-cluster/blob/main/docs/Airflow/Pics/full_reload_arch.drawio.png" alt="Архитектура Full_reload">

## Даги для работы full_reload

Для выполнения процесса **full_reload** был разработан каскад дагов:

1. **Extract config**
2. **Full reload all** — каскад дагов для загрузки данных из различных схем БД (источник).
3. **Full_reload_{schema_name}** — индивидуальные даги для загрузки таблиц из одной выбранной схемы.

---

## 1. Extract config DAG

В корне проекта, в папке **config**, расположена таблица Excel для описания конфигурации выгружаемых таблиц. Сущность таблицы представлена в виде:

| DB_source_Name | Schema_Name_Source | Table_Name_Source | DB_target_Name | Schema_Name_Target | Table_Name_Target | Reload |
|----------------|--------------------|-------------------|----------------|--------------------|-------------------|--------|

**Поле Reload**:  
Значение 0/1, которое обозначает необходимость загрузки таблицы. Если значение 1, то таблица будет загружена, если 0 — нет.

Таблица заполняется вручную и служит для мэппинга — откуда и куда необходимо загрузить таблицы.

Даг подключается к БД **STG_DATABASE**, где есть схема **config** с таблицей **configuration**, выполняет очистку этой таблицы и затем загружает данные из файла **config.xlsx**.

---

## 2. Full_reload_{schema_name}

Этот даг предназначен для загрузки таблиц из одной базы данных в другую. Он работает с одной выбранной схемой источника и копирует данные в разные схемы приёмника.

**Состав дага:**

- **start** — пустой оператор, который подразумевает начало работы дага.
- **end** — пустой оператор, который подразумевает конец работы дага.
- **replicate_group** — оператор, который вызывает функцию наполнения таблицы.

**Структура работы дага:**
- **Парсинг дага** — инициализация дага, при которой UI получает все данные о таблицах и схемах.
- Внутри дага, перед его работой, выполняется функция **get_table_list()**, которая получает список таблиц для загрузки.
  - Функция **get_table_list()** подключается к БД, схеме **config**, таблице **configuration** и читает оттуда список таблиц с флагом `Reload=1`. Схема, из которой происходит загрузка данных, задается в **Variables**.
  
После старта дага выполняется таска **replicate_group**, которая выполняет следующие шаги:
1. Копирует все данные из таблиц-источников через `SELECT *`.
2. Очищает все данные в таблицах-приёмниках через команду `TRUNCATE {table_name}`.
3. Загружает данные из первого шага с помощью команды `INSERT INTO`.

Каждый даг реализуется под одну схему на источнике для предотвращения нагрузки на БД и избыточности времени при загрузке данных.

---

## 3. Full_reload_all

**Full_reload_all** — это общий даг для загрузки всех данных в БД. Даг реализован в виде каскада дагов:

1. Вызов **Extract config** — первый шаг, который обновляет таблицу **configuration** в БД для актуализации информации о выгружаемых таблицах.
2. Параллельный вызов дагов **Full_reload_{schema_name}** — выполнение дагов для каждой конкретной схемы и таблицы, указанных в конфигурационном файле.

---

Этот процесс позволяет эффективно организовать загрузку данных в Airflow и гарантирует, что данные будут загружены только для необходимых таблиц, при этом каждый шаг выполняется с минимальной нагрузкой на систему.

### Граф дага full_reload

<image src="https://github.com/NikGerasimovich98/Data-cluster/blob/main/docs/Airflow/Pics/full_reload_all_graph.png" alt="Граф Full_Reload">
