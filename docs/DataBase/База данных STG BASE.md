# Описание Базы Данных STG BASE

<image src="https://github.com/NikGerasimovich98/Data-cluster/blob/main/docs/DataBase/Pics/STG_BASE_arch.drawio.png" alt="Архитектура STG BASE">


## 1. Информация о Базе Данных

**Название базы данных:** STG BASE  
**Система управления базами данных (СУБД):** PostgreSQL  
**Версия PostgreSQL:** 15  
**Тип развертывания:**  
База данных была развернута на сервере с использованием Docker контейнеров. PostgreSQL контейнер был настроен с учетом требований проекта и подключен к внешней сети для обеспечения взаимодействия с другими сервисами. 
[Описание контейнера](https://github.com/NikGerasimovich98/Data-cluster/blob/main/docker/DB/PostgresSQL_Container.md)

**Контейнеризация:**  
База данных работает в контейнере Docker, что позволяет легко масштабировать и развертывать БД на разных серверах.

**Основное назначение базы данных:**  
STG BASE — это промежуточная база данных для хранения сырых и трансформированных данных, используемых в процессе ETL. В этой базе хранятся данные, которые затем передаются в основную систему или хранилище данных для аналитики и отчетности.

---

## 2. Иерархия схем в БД

В базе данных **STG BASE** используется несколько схем, каждая из которых отвечает за конкретное направление работы с данными. Все схемы имеют четко определенные роли в процессе обработки и хранения данных.

| **Схема**         | **Описание**                                                                                                                                         |
|-------------------|------------------------------------------------------------------------------------------------------------------------------------------------------|
| **config**        | Схема для хранения конфигураций загрузки таблиц. В данную схему попадают все конфигурации, описанные в файле **config.xlsx**.                       |
| **stg_mapping**   | Схема для хранения мэппинга. В этой схеме собраны все статичные и неизменяющиеся таблицы, справочники (например, грейд блогеров и их KPI).          |
| **stg_marketing** | Схема для хранения данных по отделу маркетинга, приходящих как с API, так и с парсинга Google Sheets.                                              |
| **stg_tiktok**    | Схема для хранения данных по тик-ток блогерам, приходящих как с API, так и с парсинга Google Sheets.                                                |

Каждая схема имеет ограниченные права доступа, чтобы обеспечить безопасность и контроль над данными, которые в ней хранятся. Для каждого источника данных создается схема, которая начинается с приставки **"stg_"**, за которой следует название источника данных, из которого настроен забор данных.

---

## 3. Описание пользователей и прав доступа

| **Пользователь**  | **Роль**                 | **Права доступа**                                                                                                   |
|-------------------|--------------------------|----------------------------------------------------------------------------------------------------------------------|
| **postgres_admin** | Администратор БД         | Полный доступ ко всем схемам и таблицам базы данных. Может создавать, изменять и удалять схемы, таблицы и данные.   |
| **airflow_user**   | Пользователь для работы Airflow | Полный доступ ко всем схемам и таблицам **stg_** и **config**. Может создавать, изменять и удалять схемы, таблицы и данные. |
| **viewer_user**    | Администратор схемы      | Доступ только на чтение данных. Может выполнять SELECT-запросы в схемах **stg_**.                                     |

Каждому пользователю назначаются роли с правами, ограничивающими доступ к различным схемам и данным в базе данных. Для каждого нового пользователя необходимо создавать личную учетную запись (УЗ), в будущем интегрируя её с Active Directory (AD).

---

## 4. Системные объекты

### **postgres_fdw**

**postgres_fdw** — это системный объект в базе данных, который используется для создания внешних соединений с другими базами данных PostgreSQL. Он позволяет работать с данными, находящимися в других PostgreSQL базах данных, как если бы они были локальными. Этот объект используется для:

- **Создания внешних таблиц:**  
  С помощью **postgres_fdw** можно подключить таблицы из других баз данных и работать с ними как с обычными таблицами внутри текущей базы данных.

- **Управления подключениями:**  
  Он позволяет настраивать соединения с удаленными серверами PostgreSQL, обеспечивая доступ к данным, хранящимся в других экземплярах баз данных.

- **Репликации данных:**  
  Используется для репликации данных между базами данных, позволяя синхронизировать данные для разных проектов или этапов работы.

Для работы с **postgres_fdw** был создан пользователь **parsing_user**, который имеет все привилегии к конфигурационным файлам и схемам в БД.
