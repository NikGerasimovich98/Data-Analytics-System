# Витрина "Мой склад"

## Мэппинг парсера МС - Мой склад по полям

- **week_number** - номер недели. Недели идут с Пн по Вс, начиная с 1-го января.
- **week_start** - первый день недели.
- **week_end** - последний день недели.
- **name** - имя товара.
- **article** - артикул товара.
- **sellQuantity** - общее количество продаж (поле "количество" в МС).
- **sellPrice** - цена товара (поле "цена" в МС).
- **sellCost** - себестоимость (поле "себестоимость" в МС).
- **sellSum** - сумма (поле "сумма" в МС).
- **sellCostSum** - сумма себестоимости (поле "сумма себес." в МС).
- **returnQuantity** - общее количество возвратов (поле "возвраты/количество" в МС).
- **returnPrice** - цена товара (поле "возвраты/сумма" в МС).
- **returnCost** - себестоимость товара (поле "возвраты/себестоимость" в МС).
- **returnSum** - сумма товара (поле "возвраты/сумма" в МС).
- **returnCostSum** - сумма себестоимости (поле "возвраты/сумма себест." в МС).
- **salesMargin** - рентабельность товара (поле "рентабельность товара" в МС).
- **margin** - рентабельность продаж (поле "рентабельность продаж" в МС).
- **profit** - прибыль (поле "прибыль" в МС).

## Обработка таблицы из парсера для приведения к виду выгрузки в "Мой склад"

В отличие от МС, парсер делает выгрузку по дням в диапазоне "текущий день - 31 день". Из-за этого при фильтрации по неделям мы получаем на 1 неделе несколько записей на один товар. Для того чтобы получить данные, аналогичные МС, данные были схлопнуты по следующему алгоритму:

1. **Поле `date_data`** - поле, содержащее дату выгрузки строки, разбито на 3 поля: `week_start`, `week_end`, `week_number`. Данная разбивка необходима, чтобы получить номер недели, когда произошла выгрузка, а также промежуток для этого номера недели (первый и последний день).
2. **Отсечены все данные**, где поле `article` пустое. Это сделано для того, чтобы убрать из выгрузки все услуги и оставить только товары.
3. **Данные сгруппированы по неделям**. Группировка по номеру недели, где мы получаем все товары, которые были на неделе.
4. **Применён подсчёт всех числовых полей**, аналогичный расчёту в МС. В МС некоторые поля считаются через FIFO, а некоторые через суммирование. Ниже перечень полей, рассчитываемых через суммирование:
   - **sellQuantity** - берётся `SUM` на все записи за 1 неделю.
   - **sellSum** - берётся `SUM` на все записи за 1 неделю.
   - **sellCostSum** - берётся `SUM` на все записи за 1 неделю.
   - **returnQuantity** - берётся `SUM` на все записи за 1 неделю.
   - **returnSum** - берётся `SUM` на все записи за 1 неделю.
   - **returnCostSum** - берётся `SUM` на все записи за 1 неделю.
   - **profit** - берётся `SUM` на все записи за 1 неделю.
5. **Дальше применяется подсчёт для всех полей**, где расчёт в МС идёт через FIFO. Данные вычисления выполняются следующим шагом, т.к. в них участвуют итоговые просуммированные данные из п.4. К каждому вычислению была применена функция `ROUND(field, 2)` для того, чтобы обрезать данные до 2 знаков после запятой:
   - **sellPrice** - `sellSum / sellQuantity`
   - **sellCost** - `sellCostSum / sellQuantity`
   - **returnPrice** - `returnSum / returnQuantity`
   - **returnCost** - `returnCostSum / returnQuantity`
   - **salesMargin** - `(profit / (sellSum - returnSum)) * 100`
   - **margin** - `(profit / (sellCostSum - returnCostSum)) * 100`

## Итог

В итоге данные из витрины 1 в 1 соответствуют данным по выгрузке из МС.